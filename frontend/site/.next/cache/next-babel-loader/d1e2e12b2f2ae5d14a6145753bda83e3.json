{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _initializerDefineProperty from \"@babel/runtime/helpers/esm/initializerDefineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _applyDecoratedDescriptor from \"@babel/runtime/helpers/esm/applyDecoratedDescriptor\";\nimport _initializerWarningHelper from \"@babel/runtime/helpers/esm/initializerWarningHelper\";\n\nvar _class, _descriptor, _temp;\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport { action, computed, observable } from 'mobx';\nimport client, { USER_KEY } from 'api/client';\nimport * as storage from 'utils/storage';\nimport { GetUsernameDocument, LoginDocument, SignUpDocument } from 'api/generated';\nimport { Store } from 'stores/Store';\nvar AuthStore = (_class = (_temp = /*#__PURE__*/function (_Store) {\n  _inherits(AuthStore, _Store);\n\n  var _super = _createSuper(AuthStore);\n\n  function AuthStore() {\n    var _this;\n\n    _classCallCheck(this, AuthStore);\n\n    _this = _super.call(this);\n\n    _initializerDefineProperty(_this, \"user\", _descriptor, _assertThisInitialized(_this));\n\n    if (window === 'undefined') {\n      storage.getObject(USER_KEY).then(function (user) {\n        _this.user = user;\n      });\n    }\n\n    return _this;\n  }\n\n  _createClass(AuthStore, [{\n    key: \"hydrate\",\n    value: function hydrate(initialData) {}\n  }, {\n    key: \"setUser\",\n    value: function setUser(user) {\n      if (user) {\n        storage.setObject(USER_KEY, user);\n      } else {\n        storage.remove(USER_KEY);\n      }\n\n      this.user = user;\n    }\n  }, {\n    key: \"login\",\n    value: function () {\n      var _login = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(email, password) {\n        var _result$data$authenti;\n\n        var variables, result, bearerToken, usernameResult, _ref, colour, username;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                variables = {\n                  email: email,\n                  password: password\n                };\n                _context.next = 3;\n                return client.mutate({\n                  mutation: LoginDocument,\n                  variables: variables\n                });\n\n              case 3:\n                result = _context.sent;\n\n                if (!(result.errors && result.errors.length > 0)) {\n                  _context.next = 7;\n                  break;\n                }\n\n                // logError('LoginMutation error');\n                result.errors.forEach(function (error) {// logError(error.message);\n                });\n                return _context.abrupt(\"return\", {\n                  success: false,\n                  message: result.errors.map(function (error) {\n                    return error.message;\n                  }).join('\\n')\n                });\n\n              case 7:\n                if ((_result$data$authenti = result.data.authenticate) === null || _result$data$authenti === void 0 ? void 0 : _result$data$authenti.jwtToken) {\n                  _context.next = 9;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", {\n                  success: false,\n                  message: 'Failed to login'\n                });\n\n              case 9:\n                bearerToken = result.data.authenticate.jwtToken;\n                this.setUser({\n                  email: email,\n                  bearerToken: bearerToken\n                });\n                _context.next = 13;\n                return client.query({\n                  query: GetUsernameDocument,\n                  variables: {\n                    email: email\n                  }\n                });\n\n              case 13:\n                usernameResult = _context.sent;\n\n                if (!(usernameResult.errors && usernameResult.errors.length > 0)) {\n                  _context.next = 18;\n                  break;\n                }\n\n                usernameResult.errors.forEach(function (error) {});\n                this.setUser(undefined);\n                return _context.abrupt(\"return\", {\n                  success: false,\n                  message: result.errors.map(function (error) {\n                    return error.message;\n                  }).join('\\n')\n                });\n\n              case 18:\n                _ref = usernameResult.data.users.nodes[0], colour = _ref.colour, username = _ref.username;\n                this.setUser({\n                  username: username,\n                  email: email,\n                  bearerToken: bearerToken\n                });\n                return _context.abrupt(\"return\", {\n                  success: true\n                });\n\n              case 21:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function login(_x, _x2) {\n        return _login.apply(this, arguments);\n      }\n\n      return login;\n    }()\n  }, {\n    key: \"signUp\",\n    value: function () {\n      var _signUp = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(username, email, password) {\n        var variables, result;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                variables = {\n                  username: username,\n                  email: email,\n                  password: password\n                };\n                _context2.next = 3;\n                return client.mutate({\n                  mutation: SignUpDocument,\n                  variables: variables\n                });\n\n              case 3:\n                result = _context2.sent;\n\n                if (!(result.errors && result.errors.length > 0)) {\n                  _context2.next = 6;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", {\n                  success: false,\n                  message: result.errors.map(function (error) {\n                    return error.message;\n                  }).join('\\n')\n                });\n\n              case 6:\n                return _context2.abrupt(\"return\", this.login(email, password));\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function signUp(_x3, _x4, _x5) {\n        return _signUp.apply(this, arguments);\n      }\n\n      return signUp;\n    }()\n  }, {\n    key: \"logOut\",\n    value: function logOut() {\n      this.setUser(undefined);\n      console.log('logOUt this.user=', this.user);\n    }\n  }, {\n    key: \"isLoggedIn\",\n    get: function get() {\n      return this.user !== undefined;\n    }\n  }]);\n\n  return AuthStore;\n}(Store), _temp), (_descriptor = _applyDecoratedDescriptor(_class.prototype, \"user\", [observable], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _applyDecoratedDescriptor(_class.prototype, \"isLoggedIn\", [computed], Object.getOwnPropertyDescriptor(_class.prototype, \"isLoggedIn\"), _class.prototype), _applyDecoratedDescriptor(_class.prototype, \"setUser\", [action], Object.getOwnPropertyDescriptor(_class.prototype, \"setUser\"), _class.prototype), _applyDecoratedDescriptor(_class.prototype, \"logOut\", [action], Object.getOwnPropertyDescriptor(_class.prototype, \"logOut\"), _class.prototype)), _class);\nexport { AuthStore as default };","map":{"version":3,"sources":["/Users/theo/Code/guided/frontend/site/src/stores/AuthStore/index.ts"],"names":["action","computed","observable","client","USER_KEY","storage","GetUsernameDocument","LoginDocument","SignUpDocument","Store","AuthStore","window","getObject","then","user","initialData","setObject","remove","email","password","variables","mutate","mutation","result","errors","length","forEach","error","success","message","map","join","data","authenticate","jwtToken","bearerToken","setUser","query","usernameResult","undefined","users","nodes","colour","username","login","console","log"],"mappings":"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","sourcesContent":["import {action, computed, observable} from 'mobx';\nimport client, {USER_KEY} from 'api/client';\nimport * as storage from 'utils/storage';\nimport {\n  GetUsernameDocument,\n  GetUsernameQuery,\n  GetUsernameQueryVariables,\n  LoginDocument,\n  LoginMutation,\n  LoginMutationVariables,\n  SignUpDocument,\n  SignUpMutation,\n  SignUpMutationVariables,\n} from 'api/generated';\nimport {Store} from 'stores/Store';\n\nexport type User = {\n  bearerToken: string;\n  username?: string;\n  email: string;\n};\n\nexport default class AuthStore extends Store<User> {\n  @observable\n  user: User | undefined;\n\n  constructor() {\n    super();\n    if (window === 'undefined') {\n      storage.getObject<User>(USER_KEY).then((user) => {\n        this.user = user;\n      });\n    }\n  }\n\n  hydrate(initialData: User | undefined) {}\n\n  @computed\n  get isLoggedIn(): boolean {\n    return this.user !== undefined;\n  }\n\n  @action\n  setUser(user: User | undefined) {\n    if (user) {\n      storage.setObject(USER_KEY, user);\n    } else {\n      storage.remove(USER_KEY);\n    }\n    this.user = user;\n  }\n\n  async login(\n    email: string,\n    password: string,\n  ): Promise<{\n    success: boolean;\n    message?: string;\n  }> {\n    const variables: LoginMutationVariables = {\n      email,\n      password,\n    };\n    const result = await client.mutate<LoginMutation>({\n      mutation: LoginDocument,\n      variables,\n    });\n\n    if (result.errors && result.errors.length > 0) {\n      // logError('LoginMutation error');\n      result.errors.forEach((error) => {\n        // logError(error.message);\n      });\n      return {\n        success: false,\n        message: result.errors\n          .map((error) => {\n            return error.message;\n          })\n          .join('\\n'),\n      };\n    }\n\n    if (!result.data.authenticate?.jwtToken) {\n      return {\n        success: false,\n        message: 'Failed to login',\n      };\n    }\n\n    const bearerToken = result.data!.authenticate!.jwtToken;\n\n    this.setUser({\n      email,\n      bearerToken,\n    });\n\n    const usernameResult = await client.query<GetUsernameQuery>({\n      query: GetUsernameDocument,\n      variables: {\n        email,\n      } as GetUsernameQueryVariables,\n    });\n\n    if (usernameResult.errors && usernameResult.errors.length > 0) {\n      usernameResult.errors.forEach((error) => {});\n\n      this.setUser(undefined);\n      return {\n        success: false,\n        message: result.errors\n          .map((error) => {\n            return error.message;\n          })\n          .join('\\n'),\n      };\n    }\n\n    const {colour, username} = usernameResult.data!.users!.nodes[0]!;\n\n    this.setUser({\n      username,\n      email,\n      bearerToken,\n    });\n\n    return {\n      success: true,\n    };\n  }\n\n  async signUp(\n    username: string,\n    email: string,\n    password: string,\n  ): Promise<{success: boolean; message?: string}> {\n    const variables: SignUpMutationVariables = {\n      username,\n      email,\n      password,\n    };\n    const result = await client.mutate<SignUpMutation>({\n      mutation: SignUpDocument,\n      variables,\n    });\n\n    if (result.errors && result.errors.length > 0) {\n      return {\n        success: false,\n        message: result.errors\n          .map((error) => {\n            return error.message;\n          })\n          .join('\\n'),\n      };\n    }\n\n    return this.login(email, password);\n  }\n\n  @action\n  logOut() {\n    this.setUser(undefined);\n    console.log('logOUt this.user=', this.user);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}